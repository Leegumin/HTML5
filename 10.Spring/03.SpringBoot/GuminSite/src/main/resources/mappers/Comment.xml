<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
        PUBLIC "-//mybatis.org/DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace = "com.example.guminsite.dao.CommentDao">

    <sql id = "commentColumns">
        IDX
        ,BOARD_IDX
        ,CONTENT
        ,WRITER
        ,DELETE_YN
        ,INSERT_DATE
        ,UPDATE_DATE
        ,DELETE_DATE
    </sql>

    <insert id = "insertComment"
            parameterType = "com.example.guminsite.model.CommentDto">
        INSERT INTO TB_COMMENT (
        -- boardColumns의 값이 들어옴
        <include refid = "commentColumns"></include>
        ) VALUES (
        SQ_TB_COMMENT.NEXTVAL
        ,#{boardIdx}
        ,#{content}
        ,#{writer}
        ,'N'
        ,null
        ,SYSDATE
        ,SYSDATE
        )
    </insert>

    <!--댓글 상세조회-->
    <select id = "selectCommentDetail"
            parameterType = "Long"
            resultType = "com.example.guminsite.model.CommentDto">
        SELECT
        <include refid = "commentColumns"></include>
        FROM
        TB_COMMENT
        WHERE DELETE_YN = 'N'
        AND IDX = #{idx}
    </select>

    <!--댓글 전체조회-->
    <select id = "selectCommentAllList"
            parameterType = "com.example.guminsite.model.CommentDto"
            resultType = "com.example.guminsite.model.CommentDto">
        SELECT
        <include refid = "commentColumns"></include>
        FROM
            TB_COMMENT
        WHERE DELETE_YN = 'N'
        ORDER BY
            IDX DESC,
            INSERT_DATE DESC
    </select>

    <!--댓글 삭제(업데이트 : 'N' 값을 'Y'값으로 변형-->
    <update id = "deleteComment"
            parameterType = "Long">
        UPDATE TB_COMMENT
        SET DELETE_YN   = 'Y'
          , DELETE_DATE = SYSDATE
        WHERE IDX = #{idx}
    </update>

    <!--댓글 개수 조회 ( 노출돼어 있는 총 건수 )-->
    <select id = "selectCommentTotalCount"
            parameterType = "com.example.guminsite.model.CommentDto"
            resultType = "int">
        SELECT COUNT(*)
        FROM TB_COMMENT
        WHERE DELETE_YN = 'N'
    </select>

    <!--게시판 업데이트-->
    <update id = "updateComment"
            parameterType = "com.example.guminsite.model.CommentDto">
        UPDATE TB_COMMENT
        SET UPDATE_DATE = SYSDATE
          , CONTENT     = #{content}
          , WRITER      = #{writer}
    </update>

    <!--게시판 페이지 조회-->
    <select id = "selectBoardList"
            parameterType = "com.example.guminsite.model.BoardDto"
            resultType = "com.example.guminsite.model.BoardDto">

        <!-- * 꺽쇄 처리를 위한 방법 1-->
        <!-- *<![CDATA[]] : '<'가 일반 문자열이라는 것을 알려줌-->
        <!--        <![CDATA[-->
        <!--        SELECT *-->
        <!--        FROM (-->
        <!--        SELECT ROWNUM R,-->
        <!--                     TBB.*-->
        <!--              FROM TB_BOARD TBB-->
        <!--              WHERE ROWNUM <= #{currentPageNo} * #{recordsPerPage}-->
        <!--              AND DELETE_YN = 'N'-->
        <!--              ORDER BY-->
        <!--                  NOTICE_YN ASC,-->
        <!--                  IDX DESC,-->
        <!--                  INSERT_TIME DESC-->
        <!--              )-->
        <!--        WHERE R > (#{currentPageNo} - 1) * #{recordsPerPage}-->
        <!--        ]]>-->SELECT *
        FROM (
              SELECT ROWNUM R,
                     TBB.*
              FROM TB_BOARD TBB
              WHERE ROWNUM &lt;= #{currentPageNo} * #{recordsPerPage}
              AND DELETE_YN = 'N'
              ORDER BY
                  NOTICE_YN ASC,
                  IDX DESC,
                  INSERT_TIME DESC
              )
        WHERE R &gt; (#{currentPageNo} - 1) * #{recordsPerPage}
        <include refid = "Common.search"></include>
    </select>
</mapper>